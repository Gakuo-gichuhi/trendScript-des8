{% extends "base.html" %}
{% block title %}{{ blog.Title }} | TrendScript{% endblock %}

{% block extra_css %}
<style>
/* Blog Title */
.blog-title {
    text-align: center;
    font-family: 'Poppins', sans-serif;
    color: #27AE60;
    font-weight: 600;
    margin-bottom: 1rem;
}

/* Post Box */
.post-box {
    background: #EAE0D5; /* Lime yellow */
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0,0,0,.08);
    margin: 2rem 0;
    background-image: radial-gradient(rgba(255,255,255,0.08) 6%, transparent 6%);
    background-size: 35px 35px;
}

/* Like Button */
#like-btn {
    font-size: 1.1rem;
    padding: 0.6rem 1.2rem;
}

/* Comment Box */
.comment-box {
    padding: 1rem 0;
    border-bottom: 1px solid #eee;
}

/* Affiliate Button */
.affiliate-btn {
    background: #ffd44d;
    padding: 12px 20px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: bold;
}
.affiliate-btn:hover { opacity: 0.8; }

/* Sponsored Badge */
.sponsored-badge {
    background: #ffea4d;
    padding: 8px 12px;
    border-radius: 6px;
    display: inline-block;
    font-weight: bold;
    margin-bottom: 15px;
}

/* Affiliate Disclosure */
.affiliate-disclosure {
    background: #fff6c7;
    padding: 10px;
    border-left: 4px solid #ffd633;
    margin-bottom: 20px;
    font-size: 14px;
}

/* Blog Image */
.yt-image {
    width: 100%;
    max-width: 700px;
    height: auto;
    border-radius: 12px;
    display: block;
    margin: 0 auto 20px auto;
}
</style>
{% endblock %}

{% block body %}

<h2 class="blog-title">{{ blog.Title }}</h2>

<!-- Sponsored Badge -->
{% if blog.is_sponsored %}
<div class="sponsored-badge">
    Sponsored by {{ blog.sponsor_name }}
</div>
{% endif %}

<!-- Affiliate Disclosure -->
{% if blog.affiliate_link %}
<div class="affiliate-disclosure">
    This post contains affiliate links. We may earn a commission at no extra cost to you.
</div>
{% endif %}

<!-- Blog Image -->
{% if blog.Image %}
<img src="{{ blog.Image.url }}" class="yt-image" alt="{{ blog.Title }}">
{% endif %}

<!-- Blog Content -->
<div class="post-box blog_content">
    {{ blog.Content.html|safe }}
</div>

<!-- Affiliate Button -->
{% if blog.affiliate_link %}
<div class="affiliate-button-box">
    <a href="{{ blog.affiliate_link }}" rel="sponsored" class="affiliate-btn">
        {{ blog.affiliate_text|default:"Check Latest Price" }}
    </a>
</div>
{% endif %}

<!-- Like Button -->
<div class="mt-4 mb-4">
    <button id="like-btn" class="btn {% if user in blog.likes.all %}btn-danger{% else %}btn-success{% endif %}">
        {% if user in blog.likes.all %}‚ù§Ô∏è Unlike{% else %}ü§ç Like{% endif %} ({{ blog.total_likes }})
    </button>
</div>

<hr>

<!-- Comment Form -->
{% if user.is_authenticated %}
<form id="comment-form" class="mb-4">
    {% csrf_token %}
    <textarea id="comment-input" class="form-control mb-3" rows="3" placeholder="Write your comment..." required></textarea>
    <button type="submit" class="btn btn-primary">Post Comment</button>
</form>
{% else %}
<p><a href="{% url 'blog:login' %}">Log in</a> to comment.</p>
{% endif %}

<!-- Comments List -->
<h3>Comments ({{ comments.count }})</h3>
<div id="comments-section">
    {% for comment in comments %}
        {% include 'partials/_single_comment.html' with comment=comment %}
    {% empty %}
    <p>No comments yet. Be the first!</p>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const csrftoken = '{{ csrf_token }}';

    // Like button
    const likeBtn = document.getElementById("like-btn");
    likeBtn.addEventListener("click", function() {
        fetch("{% url 'blog:like_blog' blog.Slug %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(res => res.json())
        .then(data => {
            if(data.liked) {
                likeBtn.classList.remove('btn-success');
                likeBtn.classList.add('btn-danger');
                likeBtn.innerHTML = `‚ù§Ô∏è Unlike (${data.likes})`;
            } else {
                likeBtn.classList.remove('btn-danger');
                likeBtn.classList.add('btn-success');
                likeBtn.innerHTML = `ü§ç Like (${data.likes})`;
            }
        })
        .catch(err => console.error(err));
    });

    // Comment form
    const commentForm = document.getElementById("comment-form");
    if(commentForm){
        commentForm.addEventListener("submit", function(e){
            e.preventDefault();
            const content = document.getElementById("comment-input").value.trim();
            if(!content) return;

            fetch("{% url 'blog:post_comment' blog.Slug %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({comment: content})
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    document.getElementById("comments-section").insertAdjacentHTML('afterbegin', data.comment_html);
                    document.getElementById("comment-input").value = '';
                } else {
                    alert(data.error || "Error posting comment");
                }
            })
            .catch(err => console.error(err));
        });
    }
});
</script>
{% endblock %}
